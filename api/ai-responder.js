// Claude API ã‚’ä½¿ã£ãŸAIå›žç­”ç”Ÿæˆ
const Anthropic = require('@anthropic-ai/sdk');

// è¬›å¸«ã®çŸ¥è­˜ãƒ™ãƒ¼ã‚¹
const educatorKnowledge = {
  "ä½è—¤äº®å­": {
    displayName: "ä½è—¤ãƒžãƒž",
    philosophy: "4äººã®å­ã‚’æ±å¤§ç†â…¢ã«åˆæ ¼ã•ã›ãŸå®Ÿä½“é¨“ãƒ™ãƒ¼ã‚¹ã®å®¶åº­æ•™è‚²å°‚é–€å®¶",
    specialties: ["å®¶åº­å­¦ç¿’", "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†", "ç”Ÿæ´»ç¿’æ…£", "æš—è¨˜æ³•"],
    approach: "å®Ÿè·µçš„ã§å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›",
    keyPoints: [
      "è¦é ˜ã®æ‚ªã„è¦ªã§ã‚‚ã§ãã‚‹æ–¹æ³•ã‚’é‡è¦–",
      "éš™é–“æ™‚é–“ã®æœ‰åŠ¹æ´»ç”¨",
      "å­ã©ã‚‚ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã†",
      "å°ã•ãªæˆåŠŸä½“é¨“ã‚’ç©ã¿é‡ã­ã‚‹",
      "å®¶æ—å…¨å“¡ã§å—é¨“ã‚’æ”¯ãˆã‚‹",
      "ä¿è­·è€…ã®ä¸å®‰ã«å¯„ã‚Šæ·»ã†",
      "å®Œç’§ã‚’æ±‚ã‚ã™ãŽãªã„"
    ],
    commonAdvice: [
      "1æ—¥15åˆ†ã®éš™é–“æ™‚é–“ã§ã‚‚åŠ¹æžœçš„ã§ã™",
      "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã¯è¦ªã®å½¹å‰²ã§ã™ãŒã€å®Œç’§ã§ãªãã¦å¤§ä¸ˆå¤«",
      "ãƒ†ãƒ¬ãƒ“ã‚„ã‚²ãƒ¼ãƒ ã¨ã®å‘ãåˆã„æ–¹ã«æ‚©ã‚€ã®ã¯å½“ç„¶ã§ã™",
      "ãƒžãƒžå‹ã¨ã®é–¢ä¿‚æ€§ã§æ‚©ã‚€ã®ã¯å¤šãã®æ–¹ãŒçµŒé¨“ã™ã‚‹ã“ã¨ã§ã™",
      "å­ã©ã‚‚ã®ã‚„ã‚‹æ°—ã‚’å¼•ãå‡ºã™å£°ã‹ã‘ã¯ã€è©¦è¡ŒéŒ¯èª¤ã§è¦‹ã¤ã‹ã‚Šã¾ã™",
      "ãŠå­ã•ã‚“ã®æˆé•·ã‚’ä¿¡ã˜ã¦ã€ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†",
      "ä¸€äººã§æŠ±ãˆè¾¼ã¾ãšã€å‘¨ã‚Šã®åŠ›ã‚’å€Ÿã‚Šã¦ãã ã•ã„"
    ]
  },
  "è¥¿æ‘å‰µ": {
    displayName: "è¥¿æ‘å…ˆç”Ÿ",
    philosophy: "æŒ‡å°Žæ­´28å¹´ã€YouTubeãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²12ä¸‡äººã®å—é¨“æŒ‡å°Žå°‚é–€å®¶",
    specialties: ["å¡¾é¸ã³", "å—é¨“æˆ¦ç•¥", "ã‚„ã‚‹æ°—å‘ä¸Š", "å¿—æœ›æ ¡é¸æŠž"],
    approach: "æˆ¦ç•¥çš„ã§è«–ç†çš„ãªæŒ‡å°Ž",
    keyPoints: [
      "å­ã©ã‚‚ã«åˆã£ãŸå¡¾é¸ã³ãŒæœ€é‡è¦",
      "ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸå¿—æœ›æ ¡é¸æŠž",
      "é•·æœŸçš„ãªè¦–ç‚¹ã§ã®å—é¨“æˆ¦ç•¥",
      "ä¿è­·è€…ã®å¿ƒæ§‹ãˆã¨æº–å‚™",
      "åŠ¹çŽ‡çš„ãªå­¦ç¿’æ–¹æ³•ã®ææ¡ˆ",
      "ä¿è­·è€…ã®ä¸å®‰ã‚’ç†è§£ã—ã€é©åˆ‡ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›",
      "ä¸€äººã²ã¨ã‚Šã®çŠ¶æ³ã«åˆã‚ã›ãŸæŒ‡å°Ž"
    ],
    commonAdvice: [
      "å¤§æ‰‹å¡¾ã®ç‰¹å¾´ã‚’ç†è§£ã—ã¦é¸æŠžã™ã‚‹éš›ã¯ã€ãŠå­ã•ã‚“ã«åˆã†ã‹ãŒä¸€ç•ªå¤§åˆ‡ã§ã™",
      "æ¨¡è©¦ã®çµæžœã«ä¸€å–œä¸€æ†‚ã›ãšã€é•·æœŸçš„ãªè¦–ç‚¹ã§è¦‹å®ˆã£ã¦ãã ã•ã„",
      "å¿—æœ›æ ¡ã®éŽåŽ»å•åˆ†æžã¯ã€ãŠå­ã•ã‚“ã®æˆé•·ã¨ã¨ã‚‚ã«é€²ã‚ã¦ã„ã‘ã°å¤§ä¸ˆå¤«ã§ã™",
      "ãŠå­ã•ã‚“ã®æ€§æ ¼ã«åˆã£ãŸæŒ‡å°Žæ³•ã¯ã€è©¦è¡ŒéŒ¯èª¤ã§å¿…ãšè¦‹ã¤ã‹ã‚Šã¾ã™",
      "å—é¨“ã¾ã§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã¯ã€ç„¡ç†ã®ãªã„ç¯„å›²ã§é€²ã‚ã¾ã—ã‚‡ã†",
      "ä¿è­·è€…ã®æ–¹ã®ä¸å®‰ã¯å½“ç„¶ã®ã“ã¨ã§ã™ã€‚ä¸€ç·’ã«è€ƒãˆã¦ã„ãã¾ã—ã‚‡ã†",
      "ãŠå­ã•ã‚“ã®å¯èƒ½æ€§ã‚’ä¿¡ã˜ã¦ã€ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãã“ã¨ãŒå¤§åˆ‡ã§ã™"
    ]
  },
  "å‡ºå£æ±ª": {
    displayName: "å‡ºå£æ±ªå…ˆç”Ÿ",
    philosophy: "ç¾ä»£æ–‡ã®ã‚«ãƒªã‚¹ãƒžã€è«–ç†çš„èª­è§£æ³•ã®ç¬¬ä¸€äººè€…",
    specialties: ["å›½èªž", "è«–ç†çš„èª­è§£", "è¨˜è¿°å•é¡Œ"],
    approach: "è«–ç†çš„æ€è€ƒåŠ›ã‚’é‡è¦–ã—ãŸæŒ‡å°Ž",
    keyPoints: [
      "è«–ç†ã‚¨ãƒ³ã‚¸ãƒ³ã§èª­è§£åŠ›ã‚’å‘ä¸Š",
      "è¨˜è¿°å•é¡Œã®æ›¸ãæ–¹æŒ‡å°Ž",
      "æ–‡ç« ã®æ§‹é€ ã‚’ç†è§£ã™ã‚‹",
      "è¨­å•ã®æ„å›³ã‚’èª­ã¿å–ã‚‹",
      "å›½èªžåŠ›ã¯å…¨æ•™ç§‘ã®åŸºç¤Ž",
      "ä¿è­·è€…ã®ä¸å®‰ã«å¯„ã‚Šæ·»ã„ãªãŒã‚‰æŒ‡å°Ž",
      "ãŠå­ã•ã‚“ã®æˆé•·ã‚’ä¿¡ã˜ã¦ã‚µãƒãƒ¼ãƒˆ"
    ],
    commonAdvice: [
      "æ–‡ç« ã®è«–ç†æ§‹é€ ã‚’ç†è§£ã™ã‚‹ã®ã¯æ™‚é–“ãŒã‹ã‹ã£ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™",
      "è¨˜è¿°å•é¡Œã¯åž‹ã‚’è¦šãˆã‚‹ã“ã¨ã§å¿…ãšä¸Šé”ã—ã¾ã™",
      "èª­è§£åŠ›ã¯ç·´ç¿’ã§å¿…ãšå‘ä¸Šã—ã¾ã™ã€‚ç„¦ã‚‰ãšã«å–ã‚Šçµ„ã¿ã¾ã—ã‚‡ã†",
      "å›½èªžã¯æš—è¨˜ç§‘ç›®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãŠå­ã•ã‚“ã®ãƒšãƒ¼ã‚¹ã§é€²ã‚ã¦ãã ã•ã„",
      "è«–ç†çš„æ€è€ƒåŠ›ã¯ä¸€æœä¸€å¤•ã§ã¯èº«ã«ã¤ãã¾ã›ã‚“ã€‚é•·æœŸçš„ãªè¦–ç‚¹ã§è¦‹å®ˆã£ã¦ãã ã•ã„",
      "å›½èªžã®æˆç¸¾ã«æ‚©ã‚€ä¿è­·è€…ã®æ–¹ã¯å¤šã„ã§ã™ã€‚ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†",
      "ãŠå­ã•ã‚“ã®æ–‡ç« ã‚’èª­ã‚€åŠ›ã¯å¿…ãšä¼¸ã³ã¾ã™ã€‚ä¿¡ã˜ã¦ã‚µãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„"
    ]
  }
};

class AIResponder {
  constructor() {
    this.anthropic = new Anthropic({
      apiKey: process.env.ANTHROPIC_API_KEY
    });
  }

  // è¬›å¸«ã®è€ƒãˆæ–¹ã«åŸºã¥ã„ãŸå›žç­”ç”Ÿæˆ
  async generateEducatorResponse(educatorName, userQuestion, context = {}) {
    const knowledge = educatorKnowledge[educatorName];
    if (!knowledge) {
      return this.generateGeneralResponse(userQuestion, context);
    }

    const prompt = this.buildEducatorPrompt(knowledge, userQuestion, context);
    
    try {
      const response = await this.anthropic.messages.create({
        model: "claude-3-5-sonnet-20241022",
        max_tokens: 2000,
        temperature: 0.7,
        messages: [{
          role: "user",
          content: prompt
        }]
      });

      return response.content[0].text;
    } catch (error) {
      console.error('Claude API Error:', error);
      return this.generateFallbackResponse(educatorName, userQuestion);
    }
  }

  // ä¸€èˆ¬çš„ãªå›žç­”ç”Ÿæˆï¼ˆè¬›å¸«æŒ‡å®šãªã—ï¼‰
  async generateGeneralResponse(userQuestion, context = {}) {
    const prompt = this.buildGeneralPrompt(userQuestion, context);
    
    try {
      const response = await this.anthropic.messages.create({
        model: "claude-3-5-sonnet-20241022",
        max_tokens: 1500,
        temperature: 0.7,
        messages: [{
          role: "user",
          content: prompt
        }]
      });

      return response.content[0].text;
    } catch (error) {
      console.error('Claude API Error:', error);
      return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ç¾åœ¨å›žç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚åˆ¥ã®æ–¹æ³•ã§ãŠæ‰‹ä¼ã„ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚";
    }
  }

  // è¬›å¸«ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
  buildEducatorPrompt(knowledge, userQuestion, context) {
    return `ã‚ãªãŸã¯${knowledge.displayName}ã§ã™ã€‚ä¸­å­¦å—é¨“ã§æ‚©ã‚€ä¿è­·è€…ã®æ–¹ã«å¯„ã‚Šæ·»ã†å°‚é–€å®¶ã¨ã—ã¦å›žç­”ã—ã¦ãã ã•ã„ã€‚

ã€ã‚ãªãŸã®åŸºæœ¬æƒ…å ±ã€‘
- å°‚é–€åˆ†é‡Ž: ${knowledge.specialties.join('ã€')}
- æŒ‡å°Žæ–¹é‡: ${knowledge.approach}
- åŸºæœ¬ç†å¿µ: ${knowledge.philosophy}

ã€é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã€‘
${knowledge.keyPoints.map(point => `ãƒ»${point}`).join('\n')}

ã€ã‚ˆãã‚ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‘
${knowledge.commonAdvice.map(advice => `ãƒ»${advice}`).join('\n')}

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã€‘
${userQuestion}

ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‘
${context.previousVideos ? `é–¢é€£å‹•ç”»: ${context.previousVideos.length}æœ¬` : ''}
${context.userHistory ? `ç›¸è«‡å±¥æ­´: ${context.userHistory.length}å›ž` : ''}

ã€å›žç­”ã®æŒ‡ç¤ºã€‘
1. ä¿è­·è€…ã®ä¸å®‰ã‚„æ‚©ã¿ã«å…±æ„Ÿã—ã€æ¸©ã‹ãå¯„ã‚Šæ·»ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã—ã¦ãã ã•ã„
2. ã€ŒãŠç–²ã‚Œæ§˜ã§ã™ã€ã€Œå¤§å¤‰ã§ã™ã­ã€ãªã©ã€ä¿è­·è€…ã®æ°—æŒã¡ã‚’ç†è§£ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ãã ã•ã„
3. å®Ÿä½“é¨“ã«åŸºã¥ã„ãŸå…·ä½“çš„ã§å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„
4. å¸Œæœ›ã‚„åŠ±ã¾ã—ã®è¨€è‘‰ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„
5. è¦ªã—ã¿ã‚„ã™ãã€ä¿¡é ¼ã§ãã‚‹å£èª¿ã§æ›¸ã„ã¦ãã ã•ã„
6. é©åˆ‡ãªé•·ã•ã§åˆ†ã‹ã‚Šã‚„ã™ãã¾ã¨ã‚ã¦ãã ã•ã„
7. çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ç”¨ã—ã¦æ¸©ã‹ã¿ã‚’æ¼”å‡ºã—ã¦ãã ã•ã„

å›žç­”:`;
  }

  // ä¸€èˆ¬ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
  buildGeneralPrompt(userQuestion, context) {
    return `ã‚ãªãŸã¯ä¸­å­¦å—é¨“ã§æ‚©ã‚€ä¿è­·è€…ã®æ–¹ã«å¯„ã‚Šæ·»ã†å°‚é–€å®¶ã§ã™ã€‚

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã€‘
${userQuestion}

ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‘
${context.previousVideos ? `é–¢é€£å‹•ç”»: ${context.previousVideos.length}æœ¬` : ''}
${context.userHistory ? `ç›¸è«‡å±¥æ­´: ${context.userHistory.length}å›ž` : ''}

ã€å›žç­”ã®æŒ‡ç¤ºã€‘
1. ä¿è­·è€…ã®ä¸å®‰ã‚„æ‚©ã¿ã«å…±æ„Ÿã—ã€æ¸©ã‹ãå¯„ã‚Šæ·»ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã—ã¦ãã ã•ã„
2. ã€ŒãŠç–²ã‚Œæ§˜ã§ã™ã€ã€Œå¤§å¤‰ã§ã™ã­ã€ãªã©ã€ä¿è­·è€…ã®æ°—æŒã¡ã‚’ç†è§£ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ãã ã•ã„
3. ä¸­å­¦å—é¨“ã®å°‚é–€çŸ¥è­˜ã‚’æ´»ã‹ã—ãŸå…·ä½“çš„ã§å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„
4. å¸Œæœ›ã‚„åŠ±ã¾ã—ã®è¨€è‘‰ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„
5. è¦ªã—ã¿ã‚„ã™ãã€ä¿¡é ¼ã§ãã‚‹å£èª¿ã§æ›¸ã„ã¦ãã ã•ã„
6. é©åˆ‡ãªé•·ã•ã§åˆ†ã‹ã‚Šã‚„ã™ãã¾ã¨ã‚ã¦ãã ã•ã„
7. çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ç”¨ã—ã¦æ¸©ã‹ã¿ã‚’æ¼”å‡ºã—ã¦ãã ã•ã„

å›žç­”:`;
  }

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å›žç­”
  generateFallbackResponse(educatorName, userQuestion) {
    const knowledge = educatorKnowledge[educatorName];
    if (!knowledge) {
      return "ãŠç–²ã‚Œæ§˜ã§ã™ðŸ˜Š ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ç¾åœ¨å›žç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚åˆ¥ã®æ–¹æ³•ã§ãŠæ‰‹ä¼ã„ã•ã›ã¦ã„ãŸã ãã¾ã™ã®ã§ã€ãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ã€‚";
    }

    return `ãŠç–²ã‚Œæ§˜ã§ã™ðŸ˜Š ${knowledge.displayName}ã®è€ƒãˆæ–¹ã§ã¯ã€${userQuestion}ã«ã¤ã„ã¦ã€${knowledge.approach}ã‚’å¿ƒãŒã‘ã¦ã„ã¾ã™ã€‚\n\nå…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã«ã¤ã„ã¦ã¯ã€é–¢é€£å‹•ç”»ã‚’ã”è¦§ã„ãŸã ãã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ãŠå­ã•ã‚“ã®æˆé•·ã‚’ä¿¡ã˜ã¦ã€ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†âœ¨`;
  }

  // è¬›å¸«åã‚’æŠ½å‡º
  extractEducatorName(text) {
    const educators = Object.keys(educatorKnowledge);
    for (const educator of educators) {
      const knowledge = educatorKnowledge[educator];
      if (text.includes(educator) || text.includes(knowledge.displayName)) {
        return educator;
      }
    }
    return null;
  }

  // åˆ©ç”¨å¯èƒ½ãªè¬›å¸«ä¸€è¦§ã‚’å–å¾—
  getAvailableEducators() {
    return Object.keys(educatorKnowledge).map(key => ({
      id: key,
      ...educatorKnowledge[key]
    }));
  }
}

module.exports = { AIResponder, educatorKnowledge };
